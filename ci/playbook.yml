- name: Despliegue de API RESTx2 en Producci√≥n
  hosts: dell
  become: false
  vars:
    project_path: "/home/student/api_restx2"

  tasks:
    - name: 1. Creando directorio del proyecto si no existe
      file:
        path: "{{ project_path }}"
        state: directory
        mode: '0755'

    - name: 2. Copiando archivo .env.prod desde Jenkins al servidor
      ansible.posix.synchronize:        
        src: "{{ env_file }}" 
        dest: "{{ project_path }}/.env.prod"        

    - name: 3. Sincronizando archivos del proyecto
      ansible.posix.synchronize:
        src: "../"
        dest: "{{ project_path }}/"               
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.venv"              
    
    - name: 5. Copiando el archivo docker-compose.prod.yml desde Jenkins al servidor
      ansible.posix.synchronize:        
        src: "{{ compose_file }}" 
        dest: "{{ project_path }}/docker-compose.prod.yml"

    - name: 6 Administrando red de Docker
      community.docker.docker_network:
        name: cunori2026
        driver: bridge
        ipam_config:
          - subnet: 192.168.100.0/24        

    - name: 7. Levantar la infraestructura con Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ project_path }}"
        files:
          - docker-compose.prod.yml
        state: present
        build: always
        pull: always